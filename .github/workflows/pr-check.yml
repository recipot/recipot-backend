name: PR Quality Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  # ì»¤ë°‹ ë©”ì‹œì§€ í˜•ì‹ ê²€ì¦
  commit-message-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check commit message format
        run: |
          # í—ˆìš©ëœ ì»¤ë°‹ íƒ€ìž… íŒ¨í„´ ì •ì˜
          PATTERN="^(test|feat|refactor|fix|docs|init)(\(.+\))?: .{1,50}"
          
          # PRì˜ ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì‚¬
          INVALID_COMMITS=""
          
          for commit in $(git rev-list origin/${{ github.base_ref }}..${{ github.head_ref }}); do
            COMMIT_MSG=$(git log --format=%s -n 1 $commit)
            echo "Checking commit: $COMMIT_MSG"
            
            if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
              INVALID_COMMITS="$INVALID_COMMITS\n- $COMMIT_MSG"
            fi
          done
          
          if [ -n "$INVALID_COMMITS" ]; then
            echo "âŒ Invalid commit message format detected:"
            echo -e "$INVALID_COMMITS"
            echo ""
            echo "âœ… Valid format examples:"
            echo "- feat: ìƒˆë¡œìš´ ì‚¬ìš©ìž ì¸ì¦ ê¸°ëŠ¥ ì¶”ê°€"
            echo "- fix: ë¡œê·¸ì¸ ë²„ê·¸ ìˆ˜ì •"
            echo "- docs: README ì—…ë°ì´íŠ¸"
            echo "- test: ì‚¬ìš©ìž API í…ŒìŠ¤íŠ¸ ì¶”ê°€"
            echo "- refactor: ì½”ë“œ êµ¬ì¡° ê°œì„ "
            echo "- init: í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •"
            exit 1
          else
            echo "âœ… All commit messages follow conventional format"
          fi

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint

      - name: Run Prettier check
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          npx prettier --check "src/**/*.ts" "test/**/*.ts"

      - name: Build project
        run: |
          echo "ðŸ—ï¸ Building project..."
          npm run build

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (DB, middleware ì—°ê²° ì œì™¸)
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests (without DB)
        run: |
          echo "ðŸ§ª Running unit tests..."
          npm test

      - name: Generate test coverage
        run: |
          echo "ðŸ“Š Generating test coverage..."
          npm run test:cov

  # PR ìš”ì•½ ìƒì„±
  pr-summary:
    runs-on: ubuntu-latest
    needs: [commit-message-check, quality-check, test]
    if: always()
    steps:
      - name: PR ìš”ì•½ ìƒì„±
        run: |
          echo "## ðŸ” PR í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.commit-message-check.result }}" == "success" ]; then
            echo "âœ… **ì»¤ë°‹ ë©”ì‹œì§€**: ëª¨ë“  ì»¤ë°‹ì´ ê·œì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì»¤ë°‹ ë©”ì‹œì§€**: ì¼ë¶€ ì»¤ë°‹ì´ ê·œì¹™ì„ ìœ„ë°˜í–ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.quality-check.result }}" == "success" ]; then
            echo "âœ… **ì½”ë“œ í’ˆì§ˆ**: ESLint, Prettier, ë¹Œë“œê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì½”ë“œ í’ˆì§ˆ**: ë¦°íŠ¸ ë˜ëŠ” ë¹Œë“œì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… **í…ŒìŠ¤íŠ¸**: ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **í…ŒìŠ¤íŠ¸**: ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.commit-message-check.result }}" == "success" ] && [ "${{ needs.quality-check.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ]; then
            echo "ðŸŽ‰ **ë³‘í•© ì¤€ë¹„ ì™„ë£Œ!** ëª¨ë“  ê²€ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”§ **ì¡°ì¹˜ í•„ìš”** - ë³‘í•©í•˜ê¸° ì „ì— ì‹¤íŒ¨í•œ ê²€ì‚¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi